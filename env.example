# Backend configuration
PORT=8080

# Redis (self-hosted)
# For Docker Compose, the backend service can reach Redis at host "redis"
REDIS_URL=redis://redis:6379
ENABLE_WS_PUBSUB=1

# Stateless agent auth (set a strong, non-empty secret in production)
# Required to keep login working across multiple Cloud Run instances
AGENT_AUTH_SECRET=change-me-please

# Session durations (seconds)
# 86400 = 24h, 172800 = 48h
ACCESS_TOKEN_TTL_SECONDS=86400
# Refresh is used for long sessions and token rotation (default 30 days)
# REFRESH_TOKEN_TTL_SECONDS=2592000

# Cookie policy (Cloud Run / modern browsers)
# none|lax|strict
AUTH_COOKIE_SAMESITE=none
# Optional: only set if you use a custom domain; leave empty for Cloud Run default domain
# AUTH_COOKIE_DOMAIN=example.com
# Expose refresh token in /auth/login response when token_fallback is requested (1/0)
EXPOSE_REFRESH_TOKEN_FALLBACK=1

# Optional: bootstrap an initial admin agent if the agents table is empty.
# Useful for fresh deployments to avoid a chicken-and-egg where creating agents requires an admin login.
# BOOTSTRAP_ADMIN_USERNAME=admin
# BOOTSTRAP_ADMIN_PASSWORD=change-me
# BOOTSTRAP_ADMIN_NAME=Administrator

# Optional rate limits (per-minute)
SEND_TEXT_PER_MIN=30
SEND_MEDIA_PER_MIN=15

# Database
# Default is SQLite stored at data/whatsapp_messages.db
# DB_PATH=data/whatsapp_messages.db
#
# Multi-workspace (two WhatsApp numbers / two tenant DBs)
# ENABLE_MULTI_WORKSPACE=1
# DEFAULT_WORKSPACE=irranova
# WORKSPACES=irranova,irrakids
#
# Tenant DB paths (optional; if omitted, derived from DB_PATH like whatsapp_messages_irranova.db)
# DB_PATH_IRRANOVA=data/whatsapp_messages_irranova.db
# DB_PATH_IRRAKIDS=data/whatsapp_messages_irrakids.db
#
# Shared auth/settings DB (agents, refresh tokens, tag options). Defaults to DB_PATH unless ENABLE_MULTI_WORKSPACE=1.
# AUTH_DB_PATH=data/whatsapp_auth.db
# SQLite lock wait (ms) to keep requests from hanging under contention
# SQLITE_BUSY_TIMEOUT_MS=3000
# Hard timeout (seconds) for auth DB operations (prevents upstream 504s on slow DB)
# AUTH_DB_TIMEOUT_SECONDS=8
# /health DB check timeout (seconds)
# HEALTH_DB_TIMEOUT_SECONDS=2
# Supabase / Postgres
# DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname   # irrakids (default)
# DATABASE_URL_NOVA=postgresql+asyncpg://user:pass@host:5432/dbname # irranova (NOVA)

# Webhook processing
# ACK incoming WhatsApp webhooks quickly by enqueueing and processing in background workers.
# WEBHOOK_QUEUE_MAXSIZE=1000
# WEBHOOK_WORKERS=2
# WEBHOOK_PROCESSING_TIMEOUT_SECONDS=300
# Durable queue (no Redis): Postgres-backed queue (requires DATABASE_URL)
# WEBHOOK_USE_DB_QUEUE=1
# WEBHOOK_DB_BATCH_SIZE=25
# WEBHOOK_DB_POLL_INTERVAL_SEC=1.0
# Durable queue (recommended): Redis Streams (requires REDIS_URL)
# WEBHOOK_USE_REDIS_STREAM=1
# WEBHOOK_STREAM_KEY=wa:webhooks
# WEBHOOK_STREAM_GROUP=webhook-workers
# WEBHOOK_STREAM_DLQ_KEY=wa:webhooks:dlq
# WEBHOOK_MAX_ATTEMPTS=20
# WEBHOOK_CLAIM_MIN_IDLE_MS=60000

# WhatsApp / Catalog
# Required for sending/receiving via the Graph API
# Set your production values here (or in your deployment environment)
# WHATSAPP_ACCESS_TOKEN=...
WHATSAPP_PHONE_NUMBER_ID=639720275894706
# Optionally enforce filtering to a single phone number id (recommended)
# ALLOWED_PHONE_NUMBER_ID=639720275894706
#
# Multi-workspace WhatsApp credentials (recommended when ENABLE_MULTI_WORKSPACE=1)
# Keep irrakids envs unchanged:
# WHATSAPP_ACCESS_TOKEN=...
# WHATSAPP_PHONE_NUMBER_ID=...
# Add NOVA only:
# WHATSAPP_ACCESS_TOKEN_NOVA=...
# WHATSAPP_PHONE_NUMBER_ID_NOVA=...
# Optional: enable webhook signature verification and token validation
# META_APP_ID=...
# META_APP_SECRET=...
# CATALOG_ID=...
# Enable auto-reply with best-matching product image (0/1)
AUTO_REPLY_CATALOG_MATCH=1
# Minimum score (0.0-1.0) required to auto-reply
# AUTO_REPLY_MIN_SCORE=0.6
# Optional: limit auto-replies only to these phone numbers (comma-separated)
# Use WhatsApp IDs (digits only). Leave empty to allow all.
# Example: AUTO_REPLY_TEST_NUMBERS=212612345678,212698765432
# AUTO_REPLY_TEST_NUMBERS=

# Frontend-only: support contact phone shown in post-invoice message
# Example: +212612345678
REACT_APP_SUPPORT_PHONE=

# Survey testing (shorten delay and ignore invoice for specific numbers)
# Comma-separated WhatsApp IDs (digits only)
# Example: SURVEY_TEST_NUMBERS=212618182056
# SURVEY_TEST_NUMBERS=
# When set (>0), overrides the 4-hour wait. Example: 120 for 2 minutes.
# SURVEY_TEST_DELAY_SEC=0
# Ignore invoice presence check for test numbers (0/1)
# SURVEY_TEST_IGNORE_INVOICE=0
# Bypass 30-day cooldown for test numbers (0/1)
# SURVEY_TEST_BYPASS_COOLDOWN=0
# If not bypassing, shorten cooldown window (seconds). Example: 60
# SURVEY_TEST_COOLDOWN_SEC=60

# Google Cloud Storage
# GCS_BUCKET_NAME=...
# Optional: dedicate a second bucket only for user-uploaded media
# GCS_MEDIA_BUCKET_NAME=...
# GCS_CREDENTIALS_FILE=/app/credentials.json
# or
# GCS_CREDENTIALS_JSON={...}
# When set to 0, uploads remain private and are served via signed URLs
# GCS_PUBLIC_UPLOADS=1

# CORS for direct GCS access (configure on the bucket):
# Allow methods: GET, HEAD
# Allow headers: Range
# Expose headers: Accept-Ranges, Content-Range, Content-Length, Content-Type, ETag, Last-Modified

# Shopify (pick one set)
# SHOPIFY_API_KEY=...
# SHOPIFY_PASSWORD=...
# SHOPIFY_STORE_URL=https://example.myshopify.com

# Shopify webhook verification (recommended)
# Shopify will sign webhook bodies using the secret you set in Shopify Admin.
# You can configure ONE global secret or per-workspace secrets:
#
# Global (single-store):
# SHOPIFY_WEBHOOK_SECRET=...
#
# Per workspace (multi-store, recommended):
# SHOPIFY_WEBHOOK_SECRET_IRRAKIDS=...
# SHOPIFY_WEBHOOK_SECRET_IRRANOVA=...
#
# Webhook URL(s) to configure in Shopify Admin → Settings → Notifications → Webhooks:
# Preferred (multi-workspace):
#   https://<your-domain>/shopify/webhook/irrakids
#   https://<your-domain>/shopify/webhook/irranova
#
# Compatibility / legacy endpoint (still supported):
#   https://<your-domain>/shopify/webhooks/orders/create?workspace=irrakids
#   https://<your-domain>/shopify/webhooks/orders/create?workspace=irranova