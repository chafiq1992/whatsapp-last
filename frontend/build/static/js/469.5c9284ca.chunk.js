"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[469],{469:(e,t,r)=>{r.r(t),r.d(t,{default:()=>u});var a=r(555),s=r(674),n=r(43),l=r(950),c=r(200),i=r(415),o=r(579);const d={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_BASE||"";function u(e){let{activeUser:t,websocket:r,onMessageSent:u}=e;const[g,m]=(0,n.useState)([]),[x,h]=(0,n.useState)(!1),[y,p]=(0,n.useState)(null),b=24,[f,v]=(0,n.useState)([]),[j,w]=(0,n.useState)(!1),[N,S]=(0,n.useState)(!0),[_,C]=(0,n.useState)(b),A=(0,n.useRef)(null),k=(0,n.useRef)(null),E=(0,n.useRef)(0),[P,R]=(0,n.useState)([]),[T,L]=(0,n.useState)(new Set),[O,W]=(0,n.useState)(!1),[D,H]=(0,n.useState)(""),[B,G]=(0,n.useState)("products"),[F,I]=(0,n.useState)([]),[U,z]=(0,n.useState)(null),[K,J]=(0,n.useState)(!1),M=(0,n.useRef)(0),V=async()=>{h(!0);try{const e=await(0,i.dw)();null!==e&&void 0!==e&&e.length&&(m(e),y||p(e[0].id))}catch(e){}try{const e=await s.A.get("".concat(d,"/catalog-sets")),r=Array.isArray(e.data)?e.data:[];m(r),await(0,i.EG)(r),!y&&r.length>0&&p(r[0].id);try{const e=r.slice(0,4),t=2;let a=0;const n=async()=>{if(a>=e.length)return;const t=e[a++];if(null===t||void 0===t||!t.id)return n();const r=await(0,i.G)(t.id);if(!r||0===r.length)try{const e=await s.A.get("".concat(d,"/catalog-set-products"),{params:{set_id:t.id,limit:b}}),r=Array.isArray(e.data)?e.data:[];r.length&&await(0,i.hC)(t.id,r)}catch(l){}return n()};await Promise.all(Array.from({length:t},(()=>n())))}catch(t){}}catch(r){console.error("Error fetching sets:",r),Array.isArray(g)&&0!==g.length||m([])}h(!1)},Z=async(e,t)=>{if(!e)return[];k.current&&k.current.abort();const r=new AbortController;k.current=r,w(!0);const a=++E.current;try{const l=await s.A.get("".concat(d,"/catalog-set-products"),{params:{set_id:e,limit:t||b},signal:r.signal}),c=Array.isArray(l.data)?l.data:[];a===E.current&&y===e&&(v(c),S(c.length>=(t||b)));try{await(0,i.hC)(e,c)}catch(n){}return c}catch(l){return"CanceledError"!==(null===l||void 0===l?void 0:l.name)&&console.error("Error fetching set products:",l),a===E.current&&y===e&&S(!1),[]}finally{a===E.current&&w(!1)}};(0,n.useEffect)((()=>{if(!O||"products"!==B)return;const e=A.current;if(!e)return;const t=()=>{if(j||!N)return;e.scrollTop+e.clientHeight>=e.scrollHeight-50&&C((e=>e+b))};return e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)}),[O,B,j,N]),(0,n.useEffect)((()=>{O&&"products"===B&&y&&Z(y,_)}),[_]),(0,n.useEffect)((()=>{if(!O||"products"!==B)return;const e=A.current;if(!e)return;!(e.scrollHeight>e.clientHeight+20)&&N&&f.length>=_&&M.current<6&&(M.current+=1,C((e=>e+b)))}),[f,N,O,B,_]);const q=(0,n.useCallback)((e=>{if(!r||r.readyState!==WebSocket.OPEN)return console.error("WebSocket not connected"),null;const s="temp_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),n=(0,a.A)({id:s,user_id:t.user_id,from_me:!0,status:"sending",timestamp:(new Date).toISOString(),temp_id:s},e);return r.send(JSON.stringify({type:"send_message",data:n})),L((e=>new Set([...e,s]))),u&&u(n),s}),[r,null===t||void 0===t?void 0:t.user_id,u]),Q=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(null!==t&&void 0!==t&&t.user_id)return q({type:"image",message:e,url:e,caption:r})};function X(e){let{onRefresh:t}=e;const[r,a]=(0,n.useState)(!1),[l,i]=(0,n.useState)(!1);return(0,o.jsx)("button",{onClick:async()=>{a(!0),i(!1);try{const r=await s.A.post("".concat(d,"/refresh-catalog-cache"));try{await V()}catch(e){}t&&t(null===r||void 0===r?void 0:r.data),i(!0)}catch(r){console.error("Error refreshing catalog:",r)}finally{setTimeout((()=>i(!1)),1500),a(!1)}},disabled:r,className:"p-1.5 rounded-lg text-gray-300 hover:text-white hover:bg-gray-800 transition-colors ".concat(r?"opacity-70":""),type:"button",title:r?"Syncing\u2026":"Sync catalog","aria-label":"Sync catalog",children:(0,o.jsx)(c.jTZ,{className:"".concat(r?"animate-spin":""," ").concat(l?"text-green-400":"")})})}(0,n.useEffect)((()=>{if(!r)return;const e=e=>{try{const t=JSON.parse(e.data);if("message_status_update"===t.type){const{temp_id:e,status:r}=t.data;e&&T.has(e)&&("sent"!==r&&"failed"!==r||L((t=>{const r=new Set(t);return r.delete(e),r})))}}catch(t){console.error("Error parsing WebSocket message:",t)}};return r.addEventListener("message",e),()=>{r.removeEventListener("message",e)}}),[r,T]),(0,n.useEffect)((()=>{V()}),[]);const Y=r&&r.readyState===WebSocket.OPEN,$=P.length,ee=async e=>{z(e);H("girls"===e?"Girls":"boys"===e?"Boys":"All Sets"),G("folders"),R([]),v([]),W(!0);const t="all"===e?g.filter((e=>null===e||void 0===e?void 0:e.id)):(e=>{const t=String(e||"").trim().toLowerCase();return g.filter((e=>((null===e||void 0===e?void 0:e.name)||(null===e||void 0===e?void 0:e.id)||"").toString().toLowerCase().startsWith(t)))})(e);I(t);try{const e=t.slice(0,4),r=2;let a=0;const n=async()=>{if(a>=e.length)return;const t=e[a++];if(null===t||void 0===t||!t.id)return n();const r=await(0,i.G)(t.id);if(!r||0===r.length)try{const e=await s.A.get("".concat(d,"/catalog-set-products"),{params:{set_id:t.id,limit:b}}),r=Array.isArray(e.data)?e.data:[];r.length&&await(0,i.hC)(t.id,r)}catch(l){}return n()};await Promise.all(Array.from({length:r},(()=>n())))}catch(r){}},te=async e=>{await(async e=>{p(e.id),H(e.name||e.id),G("products"),C(b),M.current=0,R([]),w(!0),W(!0);try{const t=await(0,i.G)(e.id);Array.isArray(t)&&t.length&&v(t)}catch(t){}await Z(e.id,b)})(e)};return(0,o.jsxs)("div",{className:"bg-gray-900 text-white border-t border-gray-800 p-2 w-full max-h-[110px] overflow-hidden rounded-b-xl shadow-sm flex-none",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,o.jsx)("h2",{className:"text-sm font-semibold text-gray-200",children:"Catalog"}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)(X,{onRefresh:()=>{}}),(0,o.jsx)("div",{className:"w-2.5 h-2.5 rounded-full ".concat(Y?"bg-green-500":"bg-red-500"),title:Y?"Connected":"Disconnected"}),(0,o.jsx)("div",{className:"text-xs text-gray-400",children:"WS"})]})]}),K&&(0,o.jsxs)("div",{className:"flex items-center mb-2 text-xs text-gray-500",children:[(0,o.jsx)("span",{className:"inline-block w-3 h-3 mr-1 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"}),"Sending full set\u2026"]}),(0,o.jsx)("div",{className:"catalog-sets grid grid-cols-3 gap-2 max-h-[84px]",children:x?(0,o.jsx)("div",{className:"text-xs text-gray-500 col-span-full",children:"Loading sets\u2026"}):0===g.length?(0,o.jsxs)("div",{className:"text-xs text-gray-400 col-span-full flex items-center gap-2",children:[(0,o.jsx)("span",{children:"No sets available."}),(0,o.jsx)("button",{className:"px-2 py-1 bg-gray-800 border border-gray-700 text-gray-200 rounded hover:bg-gray-700",onClick:V,type:"button",children:"Retry"})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700",type:"button",onClick:()=>ee("girls"),children:"Girls"}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700",type:"button",onClick:()=>ee("boys"),children:"Boys"}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700",type:"button",onClick:()=>ee("all"),children:"All"})]})}),O&&(0,l.createPortal)((0,o.jsx)("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center",children:(0,o.jsxs)("div",{className:"relative bg-white rounded-xl p-4 w-[96vw] max-w-6xl max-h-[90vh] flex flex-col shadow-2xl",children:[(0,o.jsxs)("div",{className:"flex items-center gap-3 mb-3",children:["products"===B&&(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300",onClick:()=>{G("folders"),v([]),R([])},children:"\u2190 Back"}),(0,o.jsx)("div",{className:"font-semibold text-gray-800 text-base flex-1 truncate",children:D}),"products"===B?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("span",{className:"text-sm text-gray-700 mr-2",children:["Selected: ",$]}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300",onClick:()=>{const e=f.map((e=>{var t,r;return null===(t=e.images)||void 0===t||null===(r=t[0])||void 0===r?void 0:r.url})).filter(Boolean);R(e)},children:"Select all"}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300",onClick:()=>R([]),children:"Clear"}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-blue-600 text-white disabled:opacity-50",disabled:!Y||0===$,onClick:()=>{(async()=>{if(null!==t&&void 0!==t&&t.user_id&&0!==P.length)for(const e of P)Q(e),await new Promise((e=>setTimeout(e,40)));else alert("Please select at least one image.")})(),W(!1)},children:"Send selected"}),(0,o.jsx)("button",{className:"px-3 py-2 text-sm rounded bg-green-600 text-white",onClick:()=>{(async()=>{if(null===t||void 0===t||!t.user_id||!y)return;const e=g.find((e=>e.id===y)),r=[];null!==e&&void 0!==e&&e.name&&r.push(e.name),null!==e&&void 0!==e&&e.item_count&&r.push("".concat(e.item_count," items"));const a=r.join(" \u2022 "),n=r.length?"Envoi de l'ensemble complet : ".concat(a,"\u2026\n\u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0645\u062c\u0645\u0648\u0639\u0629 \u0643\u0627\u0645\u0644\u0629: ").concat(a,"\u2026"):"Envoi de l'ensemble complet\u2026\n\u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0645\u062c\u0645\u0648\u0639\u0629 \u0643\u0627\u0645\u0644\u0629\u2026",l=q({type:"text",message:n});J(!0);try{await s.A.post("".concat(d,"/send-catalog-set-all"),new URLSearchParams({user_id:t.user_id,set_id:y,caption:r.join(" \u2022 "),temp_id:l}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}catch(c){console.error("Error sending full set:",c)}finally{J(!1)}})(),W(!1)},children:"Send whole set"})]}):(0,o.jsx)("span",{className:"text-sm text-gray-700",children:"Select a set"}),(0,o.jsx)("button",{className:"ml-2 px-3 py-2 text-sm rounded bg-red-600 text-white",onClick:()=>W(!1),children:"Close"})]}),(0,o.jsx)("div",{ref:A,className:"flex-1 min-h-0 overflow-y-auto pr-1 h-[72vh]",children:"folders"===B?(0,o.jsx)("div",{className:"grid grid-cols-4 gap-3",children:0===F.length?(0,o.jsx)("div",{className:"text-center text-gray-500 text-sm py-6 col-span-4",children:"No sets found."}):F.map((e=>(0,o.jsxs)("button",{className:"relative border rounded p-3 bg-gray-50 hover:bg-gray-100 text-left",title:e.name||e.id,onClick:()=>te(e),type:"button",children:[(0,o.jsx)("div",{className:"w-10 h-7 mb-2 bg-yellow-300 rounded-sm"}),(0,o.jsx)("div",{className:"text-xs font-medium text-gray-800 truncate",children:e.name||e.id})]},e.id)))}):(0,o.jsxs)(o.Fragment,{children:[j&&0===f.length?(0,o.jsx)("div",{className:"grid grid-cols-4 gap-2",children:Array.from({length:12}).map(((e,t)=>(0,o.jsx)("div",{className:"h-24 bg-gray-100 animate-pulse rounded"},t)))}):0===f.length?(0,o.jsx)("div",{className:"text-center text-gray-500 text-sm py-6",children:"No products in this set."}):(0,o.jsx)("div",{className:"grid grid-cols-4 gap-3",children:f.map(((e,r)=>{var a,s;const n=null===(a=e.images)||void 0===a||null===(s=a[0])||void 0===s?void 0:s.url,l=n&&P.includes(n);return(0,o.jsxs)("div",{className:"relative group border rounded overflow-hidden",children:[n&&(0,o.jsx)("input",{type:"checkbox",className:"absolute top-2 right-2 z-10 scale-150 cursor-pointer",checked:l,onChange:()=>(e=>{R((t=>t.includes(e)?t.filter((t=>t!==e)):[...t,e]))})(n)}),(0,o.jsx)("div",{className:"w-full h-32 bg-gray-100 flex items-center justify-center",children:n?(0,o.jsx)("img",{src:n,"data-src":n,alt:e.name,className:"w-full h-32 object-cover",loading:"lazy",onError:e=>{const t=e.currentTarget;if("1"===t.dataset.fallback)return;t.dataset.fallback="1";const r=t.getAttribute("data-src")||t.src;t.src="".concat(d,"/proxy-image?url=").concat(encodeURIComponent(r))}}):(0,o.jsx)("span",{className:"text-xs text-gray-400",children:"No Image"})}),(0,o.jsxs)("div",{className:"p-2 flex items-center justify-between bg-white",children:[(0,o.jsx)("div",{className:"text-xs text-gray-700 truncate pr-2",title:e.name,children:e.name}),(0,o.jsx)("button",{type:"button",className:"text-xs px-2 py-1 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50",disabled:!Y,onClick:()=>{(async e=>{if(null===t||void 0===t||!t.user_id||null===e||void 0===e||!e.retailer_id)return;const r=null!==e&&void 0!==e&&e.name&&null!==e&&void 0!==e&&e.price?"".concat(e.name," \u2022 ").concat(e.price):(null===e||void 0===e?void 0:e.name)||"";q({type:"catalog_item",message:r||"Product",product_retailer_id:String(e.retailer_id||e.product_retailer_id||e.id),caption:r})})(e),W(!1)},title:"Send as catalog product",children:"Send Product"})]})]},"".concat(e.retailer_id,"-").concat(r))}))}),j&&f.length>0&&(0,o.jsx)("div",{className:"text-center text-gray-600 text-sm py-3",children:"Loading\u2026"}),!j&&N&&(0,o.jsx)("div",{className:"flex justify-center py-3",children:(0,o.jsx)("button",{type:"button",className:"px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300",onClick:()=>C((e=>e+b)),title:"Load more items",children:"Load more"})})]})})]})}),document.body)]})}}}]);
//# sourceMappingURL=469.5c9284ca.chunk.js.map